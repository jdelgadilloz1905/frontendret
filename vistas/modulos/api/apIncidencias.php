<?php/** * Created by PhpStorm. * User: JORGE DELGADILLO * Date: 26/11/2019 * Time: 01:43 PM */$json = file_get_contents('php://input');// decodifica el JSON recibido y lo almacena en la variable $obj$obj = json_decode($json,true);if($obj["funcion"]=="MostrarIncidenciasTecnicoAPI"){    $id_usuario = $obj["usuario"];    $limite = $obj["limite"];    $posicion = $obj["posicion"];    $totalIncidencias = ControladorIncidencia::ctrMostrarIncidenciasTecnicoAPI("id_tecnico",$id_usuario,$limite,$posicion);    if(!empty($totalIncidencias)){        echo json_encode(array(            "incidencias" =>$totalIncidencias,            "resul" =>true,            "mensaje" =>"Si hay mas servicios"        ));    }else{        echo json_encode(array(            "resul" =>false,            "incidencias" =>"",            "mensaje" =>"No hay mas servicios"        ));    }}if($obj["funcion"]=="mostrarIncidencia"){    $id_usuario = $obj["usuario"];    $limite = $obj["limite"];    $search = $obj["search"];    $resultado = ControladorIncidencia::ctrMostrarIncidenciaTecnicoLikeAPI("id_tecnico",$id_usuario,$limite,$search);    if(!empty($resultado)){        echo json_encode(array(            "resul" =>true,            "incidencias"=>$resultado,            "mensaje" =>"Si hay mas servicios",        ));    }else{        echo json_encode(array(            "resul" =>false,            "incidencias"=>"",            "mensaje" =>"No hay mas servicios",                    ));    }}if($obj["funcion"] =="MostrarImagenIncidencia"){    $id_incidencia = $obj["id_incidencia"];    $resultadoAntes = ControladorIncidencia::ctrMostrarImagenesIncidencia($id_incidencia,"antes");    $resultadoDespues = ControladorIncidencia::ctrMostrarImagenesIncidencia($id_incidencia,"despues");    echo json_encode(array(        "imageUriSelected"=>$resultadoAntes,        "imageUriSelected2"=>$resultadoDespues    ));}if($_POST["funcion"] == "ActualizarServicioGeneralAPI"){    $datos = array(        "id_incidencia" => ltrim($_POST["id_incidencia"],'0'),        "estatus" => $_POST["estatus"],        "horaSalida" => $_POST["horaSalida"],        "horaEntrada" => $_POST["horaEntrada"],        "vaciado" => ($_POST["vaciado"]=='true') ? "on":"",        "vaciadoParcial" => ($_POST["vaciadoParcial"]=='true') ? "on":"",        "otros" => ($_POST["otros"]=='true') ? "on":"",        "limpezaRegular" => ($_POST["limpezaRegular"]=='true') ? "on":"",        "inspeccion" => ($_POST["inspeccion"]=='true') ? "on":"",        "interceptorAceite" => ($_POST["interceptorAceite"]=='true') ? "on":"",        "tanqueAlmacenamiento" => ($_POST["tanqueAlmacenamiento"]=='true') ? "on":"",        "pozoSeptico" => ($_POST["pozoSeptico"]=='true') ? "on":"",        "estacionBombas" => ($_POST["estacionBombas"]=='true') ? "on":"",        "tanqueRecibidor" => ($_POST["tanqueRecibidor"]=='true') ? "on":"",        "tanqueAceites" => ($_POST["tanqueAceites"]=='true') ? "on":"",        "otros1" => ($_POST["otros1"]=='true') ? "on":"",        "interior" => ($_POST["interior"]=='true') ? "on":"",        "exterior" => ($_POST["exterior"]=='true') ? "on":"",        "interiorExterior" => ($_POST["interiorExterior"]=='true') ? "on":"",        "limpiezaDerrameLiquido" => ($_POST["limpiezaDerrameLiquido"]=='true') ? "on":"",        "limpiezaManhole" => ($_POST["limpiezaManhole"]=='true') ? "on":"",        "limpiezaLiftStation" => ($_POST["limpiezaLiftStation"]=='true') ? "on":"",        "limpiezaTuberias" => ($_POST["limpiezaTuberias"]=='true') ? "on":"",        "limpiezaTuberiasNum" => $_POST["limpiezaTuberiasNum"],        "limpiezaregistrosDesagues" => ($_POST["limpiezaregistrosDesagues"]=='true') ? "on":"",        "limpiezaregistrosNum" => $_POST["limpiezaregistrosNum"],        "limpiezaDesaguesNum" => $_POST["limpiezaDesaguesNum"],        "remocionAcarreo" => ($_POST["remocionAcarreo"]=='true') ? "on":"",        "remocionGrasas" => ($_POST["remocionGrasas"]=='true') ? "on":"",        "otros2" => ($_POST["otros2"]=='true') ? "on":"",        "vacuum" => ($_POST["vacuum"]=='true') ? "on":"",        "vacuumNum" => $_POST["vacuumNum"],        "vacuumPortable" => ($_POST["vacuumPortable"]=='true') ? "on":"",        "waterJetter" => ($_POST["waterJetter"]=='true') ? "on":"",        "tankTruck" => ($_POST["tankTruck"]=='true') ? "on":"",        "otros3" => ($_POST["otros3"]=='true') ? "on":"",        "coverAll" => ($_POST["coverAll"]=='true') ? "on":"",        "guantes" => ($_POST["guantes"]=='true') ? "on":"",        "capacete" => ($_POST["capacete"]=='true') ? "on":"",        "equipoEspacioConfinado" => ($_POST["equipoEspacioConfinado"]=='true') ? "on":"",        "otros5" => ($_POST["otros5"]=='true') ? "on":"",        "comentario" => $_POST["comentario"],        "desechosLiquidos" => ($_POST["desechosLiquidos"]=='true') ? "on":"",        "aguasResiduales" => ($_POST["aguasResiduales"]=='true') ? "on":"",        "aceitesVegetales" => ($_POST["aceitesVegetales"]=='true') ? "on":"",        "otros4" => ($_POST["otros4"]=='true') ? "on":"",        "totalDesperciado" => $_POST["totalDesperciado"],        "planta_tratamiento" => ($_POST["planta_tratamiento"]=='true') ? "on":"",        "otra_facilidad" => ($_POST["otra_facilidad"]=='true') ? "on":"",        "tecnicoAdicional" => $_POST["tecnicoAdicional"]    );    //realizo la actualizacion del formulario    $respuesta = ControladorIncidencia::ctrRegistroServicioGeneralAPI($datos);    if($respuesta == "ok"){        $mensaje = "Se ha actualizado el servicio correctamente";        //almaceno la firma del cliente        $baseFromImagen64 = $_POST["signature"];        //$base_to_php = explode(',', $baseFromImagen64);        //$data = base64_decode($base_to_php[1]);        $data = base64_decode(preg_replace('#^data:image/\w+;base64,#i', '', $baseFromImagen64));        $filepath = "vistas/img/firmas/".ltrim($_POST["id_incidencia"],'0').".png"; // or image.jpg elimino los ceros a la izquierda para        file_put_contents($filepath, $data);    }else{        $mensaje = "Ha ocurrido un error, por favor consulte con el administrador";    }    echo json_encode(array(        "resultado"=>$respuesta,        "mensaje" =>$mensaje    ));}?>